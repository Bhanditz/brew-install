#!/usr/bin/env bash

# Version = ${project.version}

set -e

# Extract java opts
java_opts=()
while [ $# -gt 0 ]
do
  case "$1" in
    -J*)
      java_opts+=("${1:2}")
      shift
      ;;
    *)
      break
      ;;
  esac
done

# Extract classpath opts
show_classpath=false
verbose=false
force=false
while [ $# -gt 0 ]
do
  case "$1" in
    -R*)
      resolve_aliases="${1:2}"
      shift
      ;;
    -C*)
      classpath_aliases="${1:2}"
      shift
      ;;
    -Spath)
      show_classpath=true
      shift
      ;;
    -Sverbose)
      verbose=true
      shift
      ;;
    -Sforce)
      force=true
      shift
      ;;
    *)
      break
      ;;
  esac
done

# Find java executable
JAVA_CMD=$(type -p java)
if [[ ! -n "$JAVA_CMD" ]]; then
  if [[ -n "$JAVA_HOME" ]] && [[ -x "$JAVA_HOME/bin/java" ]]; then
    JAVA_CMD="$JAVA_HOME/bin/java"
  else
    >&2 echo "Couldn't find 'java'. Please set JAVA_HOME."
  fi
fi

# Set dir containing the installed files
install_dir=PREFIX

# Determine user config directory
if [[ -n "$CLJ_CONFIG" ]]; then
  config_dir="$CLJ_CONFIG"
elif [[ -n "$XDG_CONFIG_HOME" ]]; then
  config_dir="$XDG_CONFIG_HOME/clojure"
else
  config_dir="$HOME/.clojure"
fi

# Determine user cache directory
if [[ -n "$CLJ_CACHE" ]]; then
  user_cache_dir="$CLJ_CACHE"
elif [[ -n "$XDG_CACHE_HOME" ]]; then
  user_cache_dir="$XDG_CACHE_HOME/clojure"
else
  user_cache_dir="$config_dir/.cpcache"
fi

# Include install and config deps.edn in config paths
config_paths=("$install_dir/deps.edn" "$config_dir/deps.edn" "deps.edn")

# Determine whether to use user or project cache
if [[ -f deps.edn ]]; then
  cache_dir=.cpcache
else
  cache_dir="$user_cache_dir"
fi

# Construct location of cached classpath file
if [[ -n "$resolve_aliases" ]]; then
  libs_root="$cache_dir/$resolve_aliases"
else
  libs_root="$cache_dir/default"
fi
libs_file="$libs_root.libs"

if [[ -n "$classpath_aliases" ]]; then
  cp_file="$libs_root/$classpath_aliases.cp"
else
  cp_file="$libs_root/default.cp"
fi

# Print paths in verbose mode
if "$verbose"; then
  echo "install_dir = $install_dir"
  echo "config_dir  = $config_dir"
  echo "cache_dir   = $cache_dir"
  echo "libs_file   = $libs_file"
  echo "cp_file     = $cp_file"
fi

# Check for stale classpath file
stale=false
if "$force" || [ ! -f "$cp_file" ] || [ ! -f "$libs_file" ] || [ "$libs_file" -nt "$cp_file" ]; then
  stale=true
else
  for config_path in "${config_paths[@]}"; do
    if [ "$config_path" -nt "$cp_file" ]; then
      stale=true
      break
    fi
  done
fi

# If stale, run makecp to refresh cached classpath
if "$stale"; then
  if "$verbose"; then
    echo "cp_file is stale"
  fi
  tools_cp="$install_dir/libexec/clojure-scripts-${project.version}.jar"
  tools_args=()

  if [[ -n "$resolve_aliases" ]]; then
    tools_args+=("-R$resolve_aliases")
  fi
  if [[ -n "$classpath_aliases" ]]; then
    tools_args+=("-C$classpath_aliases")
  fi

  config_str=$(printf ",%s" "${config_paths[@]}")
  config_str=${config_str:1}
  "$JAVA_CMD" -Xmx256m -classpath "$tools_cp" clojure.main -m clojure.tools.deps.alpha.makecp "--config-paths=$config_str" "--cache-path=$cache_dir" "${tools_args[@]}"
fi

cp=$(cat "$cp_file")

if "$show_classpath"; then
  echo "$cp"
else
  "$JAVA_CMD" "${java_opts[@]}" -classpath "$cp" clojure.main "$@"
fi
